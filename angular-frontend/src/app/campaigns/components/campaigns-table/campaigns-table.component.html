@if (model$ | async; as model) {
@if (model.loading) {
<ng-container *ngTemplateOutlet="loading"></ng-container>
} @else if (model.error) {
<ng-container *ngTemplateOutlet="error; context: { $implicit: model.error }"></ng-container>
} @else {
<ng-container *ngTemplateOutlet="view; context: { $implicit: model }"></ng-container>
}
}

<!-- Loading Template -->
<ng-template #loading>
    <div class="campaigns-table-container">
        <div class="skeleton-table">
            <div class="skeleton-header">
                @for (column of columns; track column.field) {
                <div class="skeleton-cell" [ngStyle]="column.style"></div>
                }
            </div>
            @for (item of [1,2,3,4,5]; track item) {
            <div class="skeleton-row">
                @for (column of columns; track column.field) {
                <div class="skeleton-cell" [ngStyle]="column.style"></div>
                }
            </div>
            }
        </div>
    </div>
</ng-template>

<!-- Error Template -->
<ng-template #error let-error>
    <div class="error-container">
        <mat-icon>error</mat-icon>
        <h3>Error Loading Campaigns</h3>
        <p>{{ error }}</p>
        <button mat-raised-button color="primary" (click)="ngOnInit()">
            <mat-icon>refresh</mat-icon>
            Retry
        </button>
    </div>
</ng-template>

<!-- View Template -->
<ng-template #view let-model>
    <div class="campaigns-table-container" *ngIf="currentSort$ | async as currentSort">
        <div class="table-header">
            <button mat-raised-button color="primary" routerLink="/create" class="create-btn">
                <mat-icon>add</mat-icon>
                Create Campaign
            </button>
        </div>
        <table mat-table [dataSource]="model.campaigns" class="mat-elevation-z8" matSort
            (matSortChange)="onSortChange($event)" [matSortActive]="currentSort.active"
            [matSortDirection]="currentSort.direction" matSortDisableClear>
            <!-- Dynamic columns based on configuration -->
            @for (column of columns; track column.field) {
            <ng-container [matColumnDef]="column.field">
                @if (column.isSortable) {
                <th mat-header-cell *matHeaderCellDef [ngStyle]="column.style" mat-sort-header>
                    {{ column.name }}
                </th>
                } @else {
                <th mat-header-cell *matHeaderCellDef [ngStyle]="column.style">
                    {{ column.name }}
                </th>
                }
                <td mat-cell *matCellDef="let campaign" [ngStyle]="column.style">
                    @switch (column.field) {
                    @case (FieldEnum.NAME) {
                    <a [routerLink]="['/campaign', campaign.id]" class="campaign-name-link">
                        {{ campaign.name }}
                    </a>
                    }
                    @case (FieldEnum.CONTENT_URL) {
                    <ng-container *ngTemplateOutlet="contentTemplate; context: { $implicit: campaign }">
                    </ng-container>
                    }
                    @case (FieldEnum.STATUS) {
                    <mat-chip highlighted [color]="statusToColor[campaign.status] ?? 'default'"
                        class="mat-mdc-chip-filled">
                        {{ campaign.status }}
                    </mat-chip>
                    }
                    @case (FieldEnum.CREATED_AT) {
                    {{ campaign.createdAt | date:'short' }}
                    }
                    @case (FieldEnum.UPDATED_AT) {
                    {{ campaign.updatedAt | date:'short' }}
                    }
                    }
                </td>
            </ng-container>
            }

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        @if (model.campaigns.length === 0) {
        <div class="no-data">
            <mat-icon>inbox</mat-icon>
            <p>No campaigns found. Create your first campaign to get started!</p>
        </div>
        }

        @if (model.pagination) {
        <mat-paginator [length]="model.pagination.total" [pageSize]="model.pagination.limit"
            [pageIndex]="model.pagination.page - 1" (page)="onPageChange($event, currentSort)">
        </mat-paginator>
        }
    </div>
</ng-template>

<!-- Content Template -->
<ng-template #contentTemplate let-campaign>
    @if (campaign.result?.content) {
    @if (campaign.type === 'image') {
    <div class="image-container">
        <img [src]="campaign.result.content" alt="Generated content" class="content-preview">
        <app-image-preview [src]="campaign.result.content" alt="Generated content preview">
        </app-image-preview>
    </div>
    } @else if (campaign.type === 'text') {
    <span class="text-preview" [title]="campaign.result.content">
        {{ campaign.result.content | slice:0:50 }}...
    </span>
    }
    } @else {
    <div class="content-status-image">
        @if(statusContentConfig[campaign.status]){
        <img [src]="statusContentConfig[campaign.status].url" [alt]="statusContentConfig[campaign.status].alt"
            class="content-status-image">
        <span>{{ statusContentConfig[campaign.status].text }}</span>
        }@else {
        <span>No Content</span>
        }
    </div>
    }
</ng-template>